package hevs.aislab.magpie.agent;

import hevs.aislab.magpie.event.LogicTupleEvent;
import hevs.aislab.magpie.event.MagpieEvent;
import hevs.aislab.magpie.event.UpdateMindModelEvent;
import alice.tuprolog.InvalidTheoryException;
import alice.tuprolog.MalformedGoalException;
import alice.tuprolog.NoSolutionException;
import alice.tuprolog.Prolog;
import alice.tuprolog.SolveInfo;
import alice.tuprolog.Theory;
import alice.tuprolog.event.OutputEvent;
import alice.tuprolog.event.OutputListener;
import android.util.Log;

public class PrologAgentMind implements IAgentMind {

	private final String  TAG = getClass().getName();
	
	private Prolog prolog;
	
	private String prologOutput;
	
	public PrologAgentMind(String theory){		
		Log.i(TAG, "Theory: " + theory);
		
		prologOutput="";
		try {
			prolog = new Prolog();
			prolog.addOutputListener(new OutputListener() {
				@Override
				public void onOutput(OutputEvent e) {
					prologOutput += e.getMsg();
				}
			});
			prolog.setTheory(new Theory(theory));
		} catch (InvalidTheoryException e) {
			e.printStackTrace();
		}	
	}
	
	
	/**
	 * 
	 * This perception in the Prolog agent
	 * is going to be processed only in the case
	 * it is a LogicTuple. Events that are not
	 * LogicTuples cannot be handled by this particular
	 * mind. We suggest to use the SubsumptionMind to 
	 * work with events that are not logic tuples.
	 * 
	 */
	
	@Override
	public void updatePerception(MagpieEvent event) {
			
		if(event instanceof LogicTupleEvent) {
			try {
				//Log.i(TAG, "Tuple received: " + ((LogicTupleEvent)event).toTuple());
				prolog.solve("perceive("+((LogicTupleEvent)event).toTuple()+").");
				Log.i(TAG, prologOutput);
				prologOutput="";
			} catch (MalformedGoalException e) {
				e.printStackTrace();
			}
		} if (event instanceof UpdateMindModelEvent) {
			//stub, here you would change the behaviour of the agent
			//with the new theory
		}
	}

	@Override
	public MagpieEvent produceAction() {
		Log.i(TAG, "produceAction()");
		
		LogicTupleEvent toMagpie = null;
		
		try {
			SolveInfo sol = prolog.solve("act(A).");
			Log.i(TAG, sol.getSolution().toString());
			if (sol.isSuccess()) {
				toMagpie = new LogicTupleEvent(sol.getSolution());
			}
		} catch (MalformedGoalException e) {
			Log.e(TAG, "MalformedGoalException");
		} catch (NoSolutionException e) {
			Log.e(TAG, "NoSolutionException");
		}
		
		return toMagpie;
	}


	@Override
	public void update() {		
		try {
			prolog.solve("update.");
		} catch (MalformedGoalException e) {
			e.printStackTrace();
		}
	}
}
